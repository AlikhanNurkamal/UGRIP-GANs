# Tumor mask generation with a brain mask
Here, I am trying to generate 3D 128x128x128 patches of tumor segmentation masks taking into account the segmentation mask of a brain. One advantage of adding the segmentation mask of a brain is that the model will learn that tumors must be inside of the brain and that they cannot be randomly large (i.e. larger than the brain itself).

## Dataset
In order to train this model, I have used the BraTS-Glioma 2024 dataset, which consisted of 1251 brain MRI images with their corresponding tumor segmentation masks. However, these images have shape 240x240x155, that is why I randomly extracted 10 patches from each image of size 128x128x128 only around the tumor. So, there are no patches that contain no tumor. The total number of brain MRI images with their tumor labels used for training was 12510.

## Generator output Post-Processing: My Approaches
I apply the Softmax activation function to an output of the very last layer of the Generator with respect to the channels dimension (`dim=1`). Since the Generator outputs a 4-channel 3D image of shape 128x128x128, then each channel now contains a probability value.

1. First thing that I did was that I took an argmax with respect to the channels dimension so that the result of this operation (0 or 1 or 2 or 3) represented one of the output classes - `0: brain mask`, `1: tumor core`, `2: whole tumor`, `3: enhancing tumor`. However, there are 2 main issues with this approach:
- Argmaxing resulted in a squeezed 3-dimensional tensor (of shape 128x128x128) with only 0, 1, 2, and 3 values. All these values stand for different output classes, so the background class was the problem here. That is, the output image had to be either a brain mask or one of the tumor masks (no label for background).
- Apart from that, when applying the argmax() function, I only chose one label, making this task multi-class. However, it is believed that the task was multi-label, since it was possible to get a 1 for brain mask and a 1 for tumor core mask, for example. Also, tumor core is inside the whole tumor mask, that is why if the former was 1, then the latter should have been 1 as well. With argmax() this would not work. Thus, blindly argmaxing along the channels dimension does not work here.

2. Second idea that I came up with was to add the background label, 0, after argmaxing. Also, after argmaxing I added 1 to each value of the resultant tensor to avoid 0s in it. So, I represent the output of the Generator as a 5-channel image and then sum all values along the channels dimension. This way I tried to get labels 0, 1, 2, 3, and 4 as the resulting values. Here 0 stood for background, 1 for the brain segmentation mask, and the rest were tumor masks. This idea failed as well because even though I added the background label, this approach still did not consider the multi-label nature of the task (this problem is stated above).

3. The next idea was to first threshold the brain mask channel from the output of the Generator. The thresholding parameter was chosen to be 0.4. So, if the 0th channel of the output of the Generator contained values greater than the threshold, then they were set to 1, otherwise to 0. This allowed me to separate the foreground (brain segmentation mask) and the background, respectively. Afer that I decided not to merge the three tumor segmentation channels but to save them as separate files (one for tumor core, one for whole tumor, and one for enhancing tumor). I found this approach to be the only possible way to perform a multi-label task.
